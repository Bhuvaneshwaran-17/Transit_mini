name: Backend CI (Monorepo)

on:
  pull_request:
  push:
    branches: ["main"]

permissions:
  contents: read
  packages: write

concurrency:
  group: backend-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test - ${{ matrix.svc.name }}
    strategy:
      fail-fast: false
      matrix:
        svc: &services
          - name: auth
            pom_path: Auth/apps/pom.xml
            workdir: Auth/apps
            sonar_key: auth-backend
            dockerfile: Auth/apps/Dockerfile
          - name: tap
            pom_path: Tap/transport/pom.xml
            workdir: Tap/transport
            sonar_key: tap-backend
            dockerfile: Tap/transport/Dockerfile
          - name: transitcard
            pom_path: TransitCard/TransitCard/pom.xml
            workdir: TransitCard/TransitCard
            sonar_key: transitcard-backend
            dockerfile: TransitCard/TransitCard/Dockerfile

    uses: Bhuvaneshwaran-17/Modularized-dev-ops/.github/workflows/java-test.yml@main
    with:
      java_version: "21"
      pom_path: ${{ matrix.svc.pom_path }}
      reports_artifact_name: test-reports-${{ matrix.svc.name }}
    secrets:
      TEAMS_WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}

  sonar:
    name: Sonar - ${{ matrix.svc.name }}
    needs: test
    strategy:
      fail-fast: false
      matrix:
        svc: *services
    uses: Bhuvaneshwaran-17/Modularized-dev-ops/.github/workflows/sonarqube-analysis.yml@main
    with:
      java_version: "21"
      pom_path: ${{ matrix.svc.pom_path }}
      sonar_project_key: ${{ matrix.svc.sonar_key }}
      run_quality_gate: true
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_ORG_KEY: ${{ secrets.SONAR_ORG_KEY }}
      TEAMS_WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}

  build:
    name: Build - ${{ matrix.svc.name }}
    needs: sonar
    strategy:
      fail-fast: false
      matrix:
        svc: *services
    uses: Bhuvaneshwaran-17/Modularized-dev-ops/.github/workflows/java-build.yml@main
    with:
      project_name: ${{ matrix.svc.name }}
      java_version: "21"
      pom_path: ${{ matrix.svc.pom_path }}
      build_command: "mvn -B clean package -DskipTests"
    secrets:
      TEAMS_WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}

  docker:
    name: Docker - ${{ matrix.svc.name }}
    needs: build
    strategy:
      fail-fast: false
      matrix:
        svc: *services
    uses: Bhuvaneshwaran-17/Modularized-dev-ops/.github/workflows/docker-build-push.yml@main
    with:
      project_name: ${{ matrix.svc.name }}
      # DYNAMIC FIX: Uses your secret username so the push is authorized
      image_name: ${{ secrets.REGISTRY_USERNAME }}/${{ matrix.svc.name }}
      context: ${{ matrix.svc.workdir }}
      dockerfile: ${{ matrix.svc.dockerfile }}
      push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    secrets:
      REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
      REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
      REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
      TEAMS_WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}